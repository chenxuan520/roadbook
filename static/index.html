<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>路书制作工具</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1 id="mainTitle">路书制作工具</h1>
                <div id="onlineModeActions" class="online-mode-actions"></div>
            </div>
            <!-- 日期备注便签 -->
            <div class="search-toolbar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="搜索地点...">
                    <select id="searchMethodSelect" class="btn" style="background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.15)); color: #fff; border: 2px solid rgba(255,255,255,0.5); padding: 0.6rem 1.2rem; border-radius: 25px; font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-left: 0.5rem;">
                        <option value="auto">🗺️自动分配搜索</option>
                        <option value="photon">😀Photon搜索</option>
                        <option value="nominatim">😓Nominatim搜索</option>
                        <option value="overpass">😓Overpass搜索</option>
                        <option value="mapsearch">😀MapSearch搜索</option>
                        <option value="cnsearch">🤩CNSearch搜索</option>
                        <option value="tiansearch">🤩TianSearch搜索</option>
                    </select>
                    <!-- 搜索结果下拉框 -->
                    <div id="searchResults" class="search-results" style="display: none;">
                        <ul id="resultsList"></ul>
                    </div>
                </div>
                <div class="toolbar">
                    <button id="addMarkerBtn" class="btn">添加标记点</button>
                    <button id="connectMarkersBtn" class="btn">连接标记点</button>
                    <div class="dropdown">
                        <button id="exportDropdownBtn" class="btn dropdown-btn">导出路书 <span class="dropdown-arrow">▼</span></button>
                        <div id="exportDropdownContent" class="dropdown-content">
                            <button id="exportBtn" class="dropdown-item">导出JSON</button>
                            <button id="exportHtmlBtn" class="dropdown-item">导出HTML</button>
                        </div>
                    </div>
                    <button id="importBtn" class="btn">导入路书</button>
                    <button id="clearCacheBtn" class="btn">清除缓存</button>
                    <select id="mapSourceSelect" class="btn" style="background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.15)); color: #fff; border: 2px solid rgba(255,255,255,0.5); padding: 0.6rem 1.2rem; border-radius: 25px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">
                        <option value="osm">OpenStreetMap</option>
                        <option value="satellite">ESRI影像图</option>
                        <option value="esri_street">ESRI街道图</option>
                        <option value="gaode">高德地图</option>
                        <option value="gaode_satellite">高德卫星图</option>
                        <option value="google">Google地图</option>
                        <option value="google_satellite">Google卫星图</option>
                        <option value="tencent">腾讯地图</option>
                    </select>
                    <input type="file" id="importFile" accept=".json,.html" style="display: none;">
                </div>
            </div>
        </header>

        <main>
            <div id="mapContainer" style="height: 100%; width: 100%;">
                <!-- 地图和帮助控制按钮 -->
                <div class="map-controls">
                    <button id="fitViewBtn" class="map-control-btn" title="调整视窗以显示所有元素">
                        🎯
                    </button>
                    <button id="helpBtn" class="help-btn" title="帮助">
                        ❓
                    </button>
                </div>
                <!-- 日期备注便签 -->
                <div id="dateNotesSticky" class="date-notes-sticky" style="display: none;">
                    <div class="date-notes-header">
                        <span id="dateNotesDate"></span>
                        <button id="closeDateNotesSticky" class="close-sticky-btn">×</button>
                    </div>
                    <div id="dateNotesContent" class="date-notes-content"></div>
                </div>
            </div>
            <!-- GitHub链接 - 经典角标，覆盖在右上角 -->
            <div class="github-corner">
                <a href="https://github.com/chenxuan520/roadbook" target="_blank" class="github-corner-link" title="GitHub" rel="noopener noreferrer">
                    <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#000000; color:#fff;" aria-hidden="true">
                        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
                        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
                    </svg>
                </a>
            </div>
            <div class="right-panel">
                <!-- 日程列表 -->
                <div class="sidebar" id="markerListPanel">
                    <div class="sidebar-header">
                        <h3>日程列表</h3>
                        <span class="filter-hint">📅 点击日期分组可筛选</span>
                    </div>
                    <div id="markerList"></div>
                </div>
                <!-- 标记点详情面板 -->
                <div class="detail-panel" id="markerDetailPanel" style="display: none;">
                    <div class="detail-header">
                        <h3 id="detailTitle">标记点详情</h3>
                        <button class="close-btn" id="closeMarkerDetailBtn">&times;</button>
                    </div>
                    <div class="detail-content">
                        <div class="form-group">
                            <label>名称:</label>
                            <input type="text" id="markerNameInput" placeholder="输入标记点名称">
                        </div>
                        <div class="form-group">
                            <label>时间点:</label>
                            <div id="dateTimesContainer">
                                <!-- 时间点列表将在这里动态生成 -->
                            </div>
                            <button type="button" id="addDateTimeBtn" class="btn" style="margin-top: 0.5rem; color: #000 !important;">添加时间点</button>
                        </div>
                        <div class="form-group">
                            <label>坐标:</label>
                            <div id="markerCoords"></div>
                        </div>
                        <div class="form-group">
                            <label>标记点图标:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div id="currentIconPreview" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; border: 2px solid #667eea;"></div>
                                <button type="button" id="changeIconBtn" class="btn" style="margin: 0; color: #000 !important;">更换图标</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>标注内容:</label>
                            <textarea id="markerLabelsInput" rows="3" placeholder="输入标注内容，多个标注用分号隔开"></textarea>
                        </div>
                        <div class="detail-actions">
                            <button id="saveMarkerBtn" class="btn btn-primary">保存</button>
                            <button id="deleteMarkerBtn" class="btn btn-danger">删除</button>
                        </div>
                    </div>
                </div>
                <!-- 连接线详情面板 -->
                <div class="detail-panel" id="connectionDetailPanel" style="display: none;">
                    <div class="detail-header">
                        <h3 id="detailTitle">连接线详情</h3>
                        <button class="close-btn" id="closeConnectionDetailBtn">&times;</button>
                    </div>
                    <div class="detail-content">
                        <div class="form-group">
                            <label>时间:</label>
                            <input type="datetime-local" id="connectionDateInput">
                        </div>
                        <div class="form-group">
                            <label>耗时 (小时):</label>
                            <input type="number" id="connectionDuration" min="0" step="0.1" placeholder="请输入连接耗时（小时）">
                        </div>
                        <div class="form-group">
                            <label>起始标记点:</label>
                            <select id="connectionStartMarker"></select>
                        </div>
                        <div class="form-group">
                            <label>目标标记点:</label>
                            <select id="connectionEndMarker"></select>
                        </div>
                        <div class="form-group">
                            <label>交通方式:</label>
                            <div class="transport-buttons">
                                <button type="button" class="transport-btn" data-transport="car">
                                    <span class="icon">🚗</span>
                                    <span class="label">汽车</span>
                                </button>
                                <button type="button" class="transport-btn" data-transport="train">
                                    <span class="icon">🚄</span>
                                    <span class="label">火车</span>
                                </button>
                                <button type="button" class="transport-btn" data-transport="subway">
                                    <span class="icon">🚇</span>
                                    <span class="label">地铁</span>
                                </button>
                                <button type="button" class="transport-btn" data-transport="plane">
                                    <span class="icon">✈️</span>
                                    <span class="label">飞机</span>
                                </button>
                                <button type="button" class="transport-btn" data-transport="walk">
                                    <span class="icon">🚶</span>
                                    <span class="label">步行</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>标注内容:</label>
                            <textarea id="connectionLabelsInput" rows="3" placeholder="输入连接线标注内容"></textarea>
                        </div>
                        <div class="form-group">
                            <label>导航链接:</label>
                            <div class="navigation-links">
                                <a id="baiduNavLink" href="#" target="_blank" class="nav-link-btn">百度导航</a>
                                <a id="amapNavLink" href="#" target="_blank" class="nav-link-btn">高德导航</a>
                                <a id="qqNavLink" href="#" target="_blank" class="nav-link-btn">腾讯导航</a>
                                <a id="googleNavLink" href="#" target="_blank" class="nav-link-btn">Google导航</a>
                            </div>
                        </div>
                        <div class="form-group" id="ticketBookingSection" style="display: none;">
                            <label>购票服务:</label>
                            <div class="ticket-booking-links">
                                <a id="ctripTrainLink" href="#" target="_blank" class="nav-link-btn" style="display: none;">🚄 携程火车票</a>
                                <button id="planeTicketBtn" class="nav-link-btn" style="display: none;">✈️ 飞机票 (敬请期待)</button>
                            </div>
                        </div>
                        <div class="detail-actions">
                            <button id="saveConnectionBtn" class="btn btn-primary">保存</button>
                            <button id="deleteConnectionBtn" class="btn btn-danger">删除</button>
                        </div>
                    </div>
                </div>

                <!-- 日期详情面板 -->
                <div class="detail-panel" id="dateDetailPanel" style="display: none;">
                    <div class="detail-header">
                        <h3 id="dateDetailTitle">日期详情</h3>
                        <button class="close-btn" id="closeDateDetailBtn">&times;</button>
                    </div>
                    <div class="detail-content">
                        <div class="form-group">
                            <label>日期:</label>
                            <div id="dateDisplay"></div>
                        </div>
                        <div class="form-group">
                            <label>日期备注:</label>
                            <textarea id="dateNotesInput" rows="5" placeholder="请输入日期备注信息"></textarea>
                        </div>
                        <div class="detail-actions">
                            <button id="saveDateNotesBtn" class="btn btn-primary">保存备注</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 连接标记点模态框 -->
    <div id="connectModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>连接标记点</h3>
            <div class="form-group">
                <label>选择起始标记点:</label>
                <select id="startMarker"></select>
            </div>
            <div class="form-group">
                <label>选择目标标记点:</label>
                <select id="endMarker"></select>
            </div>
            <div class="form-group">
                <label>选择交通方式:</label>
                <div class="transport-buttons">
                    <button type="button" class="transport-btn active" data-transport="car">
                        <span class="icon">🚗</span>
                        <span class="label">汽车</span>
                    </button>
                    <button type="button" class="transport-btn" data-transport="train">
                        <span class="icon">🚄</span>
                        <span class="label">火车</span>
                    </button>
                    <button type="button" class="transport-btn" data-transport="subway">
                        <span class="icon">🚇</span>
                        <span class="label">地铁</span>
                    </button>
                    <button type="button" class="transport-btn" data-transport="plane">
                        <span class="icon">✈️</span>
                        <span class="label">飞机</span>
                    </button>
                    <button type="button" class="transport-btn" data-transport="walk">
                        <span class="icon">🚶</span>
                        <span class="label">步行</span>
                    </button>
                </div>
                <input type="hidden" id="transportType" value="car">
            </div>
            <button id="confirmConnect" class="btn">确认连接</button>
        </div>
    </div>

    <!-- 标记点图标选择模态框 -->
    <div id="iconModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="app.closeModals()">&times;</span>
            <h3>选择标记点图标</h3>
            <div class="icon-section">
                <h4>数字</h4>
                <div class="icon-grid">
                    <div class="icon-option" data-icon="0">
                        <div class="icon-preview" style="background-color: #667eea;">0</div>
                        <span>0</span>
                    </div>
                    <div class="icon-option" data-icon="1">
                        <div class="icon-preview" style="background-color: #667eea;">1</div>
                        <span>1</span>
                    </div>
                    <div class="icon-option" data-icon="2">
                        <div class="icon-preview" style="background-color: #667eea;">2</div>
                        <span>2</span>
                    </div>
                    <div class="icon-option" data-icon="3">
                        <div class="icon-preview" style="background-color: #667eea;">3</div>
                        <span>3</span>
                    </div>
                    <div class="icon-option" data-icon="4">
                        <div class="icon-preview" style="background-color: #667eea;">4</div>
                        <span>4</span>
                    </div>
                    <div class="icon-option" data-icon="5">
                        <div class="icon-preview" style="background-color: #667eea;">5</div>
                        <span>5</span>
                    </div>
                    <div class="icon-option" data-icon="6">
                        <div class="icon-preview" style="background-color: #667eea;">6</div>
                        <span>6</span>
                    </div>
                    <div class="icon-option" data-icon="7">
                        <div class="icon-preview" style="background-color: #667eea;">7</div>
                        <span>7</span>
                    </div>
                    <div class="icon-option" data-icon="8">
                        <div class="icon-preview" style="background-color: #667eea;">8</div>
                        <span>8</span>
                    </div>
                    <div class="icon-option" data-icon="9">
                        <div class="icon-preview" style="background-color: #667eea;">9</div>
                        <span>9</span>
                    </div>
                </div>
            </div>
            <div class="icon-section">
                <h4>图标</h4>
                <div class="icon-grid">
                    <div class="icon-option" data-icon="📍">
                        <div class="icon-preview" style="background-color: #667eea;">📍</div>
                        <span>标记</span>
                    </div>
                    <div class="icon-option" data-icon="🏠">
                        <div class="icon-preview" style="background-color: #FF5722;">🏠</div>
                        <span>家</span>
                    </div>
                    <div class="icon-option" data-icon="🏨">
                        <div class="icon-preview" style="background-color: #2196F3;">🏨</div>
                        <span>酒店</span>
                    </div>
                    <div class="icon-option" data-icon="🍽️">
                        <div class="icon-preview" style="background-color: #4CAF50;">🍽️</div>
                        <span>餐厅</span>
                    </div>
                    <div class="icon-option" data-icon="🏞️">
                        <div class="icon-preview" style="background-color: #FF9800;">🏞️</div>
                        <span>景点</span>
                    </div>
                    <div class="icon-option" data-icon="🛍️">
                        <div class="icon-preview" style="background-color: #9C27B0;">🛍️</div>
                        <span>购物</span>
                    </div>
                    <div class="icon-option" data-icon="🚉">
                        <div class="icon-preview" style="background-color: #607D8B;">🚉</div>
                        <span>交通</span>
                    </div>
                    <div class="icon-option" data-icon="🌳">
                        <div class="icon-preview" style="background-color: #8BC34A;">🌳</div>
                        <span>公园</span>
                    </div>
                    <div class="icon-option" data-icon="⛰️">
                        <div class="icon-preview" style="background-color: #795548;">⛰️</div>
                        <span>山峰</span>
                    </div>
                    <div class="icon-option" data-icon="🏖️">
                        <div class="icon-preview" style="background-color: #00BCD4;">🏖️</div>
                        <span>海滩</span>
                    </div>
                    <div class="icon-option" data-icon="📷">
                        <div class="icon-preview" style="background-color: #FF5722;">📷</div>
                        <span>拍照</span>
                    </div>
                    <div class="icon-option" data-icon="☕">
                        <div class="icon-preview" style="background-color: #795548;">☕</div>
                        <span>咖啡</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>自定义图标 (可选):</label>
                <input type="text" id="customIcon" placeholder="输入emoji或文字，如：🎯 或 A">
            </div>
            <div class="form-group">
                <label>图标颜色:</label>
                <input type="color" id="iconColor" value="#667eea">
            </div>
            <button id="confirmIcon" class="btn">确认选择</button>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="modal">
        <div class="modal-content help-modal-content">
            <span class="close" id="closeHelp">&times;</span>
            <h2>路书制作工具 - 帮助</h2>
            <div class="help-content">
                <h3>项目介绍</h3>
                <p>路书制作工具是一个基于网页的地图标记和路线规划工具，允许用户在地图上添加标记点、连接路线，并导出分享您的行程规划。</p>

                <h3>基本功能</h3>
                <ul>
                    <li><strong>添加标记点</strong> - 在地图上点击或使用快捷键 <kbd>A</kbd> 添加标记点</li>
                    <li><strong>连接标记点</strong> - 使用快捷键 <kbd>C</kbd> 连接两个标记点</li>
                    <li><strong>删除元素</strong> - 选中元素后使用快捷键 <kbd>D</kbd> 删除标记点或连接线</li>
                    <li><strong>自动调整视窗</strong> - 使用快捷键 <kbd>F</kbd> 自动调整视窗以显示所有元素</li>
                    <li><strong>拖拽移动</strong> - 点击并拖拽标记点来调整位置</li>
                    <li><strong>编辑详情</strong> - 点击标记点可查看和编辑详细信息</li>
                    <li><strong>查看帮助</strong> - 使用快捷键 <kbd>H</kbd> 或 <kbd>?</kbd> 打开帮助面板</li>
                    <li><strong>搜索框聚焦</strong> - 使用快捷键 <kbd>/</kbd> 聚焦到搜索框</li>
                    <li><strong>退出添加状态</strong> - 在添加标记点模式下按 <kbd>ESC</kbd> 键退出添加状态</li>
                    <li><strong>导入导出</strong> - 保存和加载路书数据</li>
                </ul>

                <h3>快捷键</h3>
                <table class="shortcut-table">
                    <tr>
                        <td><kbd>A</kbd></td>
                        <td>添加标记点模式</td>
                    </tr>
                    <tr>
                        <td><kbd>C</kbd></td>
                        <td>打开连接标记点界面</td>
                    </tr>
                    <tr>
                        <td><kbd>D</kbd></td>
                        <td>删除选中的标记点或连接线</td>
                    </tr>
                    <tr>
                        <td><kbd>F</kbd></td>
                        <td>自动调整视窗以显示所有元素</td>
                    </tr>
                    <tr>
                        <td><kbd>H</kbd> 或 <kbd>?</kbd></td>
                        <td>显示帮助面板</td>
                    </tr>
                    <tr>
                        <td><kbd>/</kbd></td>
                        <td>聚焦到搜索框</td>
                    </tr>
                    <tr>
                        <td><kbd>Ctrl</kbd> + <kbd>Z</kbd></td>
                        <td>撤销上一步操作</td>
                    </tr>
                    <tr>
                        <td><kbd>ESC</kbd></td>
                        <td>退出添加标记点模式</td>
                    </tr>
                </table>

                <h3>使用说明</h3>
                <ol>
                    <li>点击工具栏上的"添加标记点"按钮或按 <kbd>A</kbd> 键</li>
                    <li>在地图上点击以放置标记点（按 <kbd>ESC</kbd> 键可退出添加模式）</li>
                    <li>点击工具栏上的"连接标记点"按钮或按 <kbd>C</kbd> 键</li>
                    <li>选择两个标记点并连接它们</li>
                    <li>使用右侧面板编辑标记点和连接线的详细信息</li>
                    <li>使用"导出路书"按钮保存您的规划</li>
                </ol>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="script.js"></script>
    <script src="html_export.js"></script>
    <script src="online_mode.js"></script>
    <script>
        // 添加提示信息以展示新功能
        document.addEventListener('DOMContentLoaded', function() {
            console.log('路书制作工具已加载，支持Ctrl+Z撤销功能');

            // Initialize the HTML exporter module
            if (typeof RoadbookHtmlExporter !== 'undefined' && window.app) {
                window.htmlExporter = new RoadbookHtmlExporter(window.app);

                // HTML导出按钮事件现在在script.js中统一处理
            }
        });
    </script>
</body>
</html>
