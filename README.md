# 路书制作工具

路书制作工具是一个基于网页的地图标记和路线规划工具，允许用户在地图上添加标记点、连接路线，并导出分享您的行程规划。

## 项目简介

这是一个完全基于前端的路书制作工具，使用HTML、CSS和JavaScript构建，结合Leaflet地图库实现真实地图操作。用户可以在这个工具中创建、编辑和分享路线规划。

## 功能特性

- **地图操作**: 支持多种地图源（OpenStreetMap、高德地图、Google地图、卫星图等）
- **标记点管理**: 添加、编辑、删除标记点，支持自定义图标和颜色
- **路线连接**: 连接标记点，支持多种交通方式（汽车、火车、地铁、飞机、步行）
- **时间规划**: 为标记点和连接线添加时间信息，支持多时间点
- **智能搜索**: 支持多种搜索方式（Photon、Nominatim、Overpass、百度地图、天地图）
- **数据导入导出**: 支持JSON格式的路书导入导出
- **HTML导出**: 可导出为独立的HTML文件，包含完整地图信息，支持导入导出
- **本地存储**: 自动保存到本地存储，刷新后数据不丢失
- **快捷键支持**: 支持A、C、D、F、H、?、/等多种快捷键
- **撤销功能**: 支持Ctrl+Z撤销操作
- **日期分组**: 按日期对标记点进行分组显示
- **实时预览**: 在地图上实时显示标记点、连接线和路线
- **响应式设计**: 适配不同屏幕尺寸
- **中国地图服务**: 集成百度地图和天地图搜索服务，解决中国地图坐标系问题

## 使用方法

### 基本操作

1. **添加标记点**:
   - 点击工具栏"添加标记点"按钮或按 `A` 键
   - 在地图上点击以放置标记点
   - 编辑标记点详细信息（名称、时间、图标、标注等）

2. **连接标记点**:
   - 点击工具栏"连接标记点"按钮或按 `C` 键
   - 选择起始点和目标点并连接
   - 选择交通方式，设置时间、耗时等信息

3. **搜索地点**:
   - 在搜索框输入地点名称
   - 可选择不同的搜索方式（自动分配、Photon、Nominatim、Overpass、MapSearch、CNSearch、TianSearch）

4. **数据管理**:
   - 点击"导出JSON"保存路书数据
   - 点击"导入路书"加载已保存的数据
   - 点击"导出HTML"生成可分享的独立HTML文件

### 快捷键

| 快捷键 | 功能 |
|--------|------|
| `A` | 添加标记点模式 |
| `C` | 打开连接标记点界面 |
| `D` | 删除选中的标记点或连接线 |
| `F` | 自动调整视窗以显示所有元素 |
| `H` / `?` | 显示帮助面板 |
| `/` | 聚焦到搜索框 |
| `Ctrl` + `Z` | 撤销上一步操作 |

### 地图源选择

- OpenStreetMap
- ESRI卫星图
- 高德地图
- 高德卫星图
- Google地图
- Google卫星图

## 技术架构

- **前端框架**: 纯JavaScript（无框架依赖）
- **地图库**: Leaflet
- **地图数据**: OpenStreetMap、高德地图、Google地图等
- **存储方式**: 浏览器本地存储（localStorage）
- **导出格式**: JSON、HTML
- **后端API**: Go语言实现的地图搜索代理服务
- **部署方式**: Nginx反向代理

## 文件说明

- `static/index.html`: 主页面文件
- `static/script.js`: 主要应用逻辑
- `static/style.css`: 样式文件
- `static/html_export.js`: HTML导出功能实现
- `backend/main.go`: 后端API主程序
- `backend/config.json`: 后端配置文件
- `nginx.conf`: Nginx反向代理配置
- `DEPLOYMENT.md`: 部署指南
- `talk.md`: 项目需求文档
- `README.md`: 项目说明文档

## 后端服务功能

### MapSearch代理服务

一个地图搜索代理服务，提供统一的搜索能力，特别针对中国地图服务（百度地图和天地图），转换坐标到标准GPS（WGS84）格式。

#### 功能特色

- **百度地图搜索**: 代理搜索功能，包含坐标转换
- **天地图搜索**: 代理搜索功能
- **坐标转换**: 将中国坐标系统（BD-09、GCJ-02）转换为标准WGS84 GPS坐标
- **Nominatim兼容输出**: 以标准Nominatim格式返回搜索结果
- **CORS支持**: 提供跨域资源共享支持

#### API端点

- **百度地图搜索**: `/api/cnmap/search`
  ```bash
  GET /api/cnmap/search?q={query}
  ```

- **天地图搜索**: `/api/tianmap/search`
  ```bash
  GET /api/tianmap/search?q={query}
  ```

## 部署指南

请参考 `DEPLOYMENT.md` 文件获取详细的部署说明。

### 快速部署步骤

1. **安装依赖**
   - Go语言运行时环境 (用于后端)
   - Nginx服务器

2. **启动后端服务**
   ```bash
   cd backend
   go mod tidy
   go run main.go
   ```

3. **配置Nginx**
   - 使用提供的 `nginx.conf` 配置文件
   - 调整静态文件路径和后端端口配置
   - 重启Nginx服务

4. **访问应用**
   - 通过配置的域名或IP地址访问

## 坐标系统说明

由于中国法律法规要求，国内地图服务使用特殊坐标系统（GCJ-02、BD-09），本项目后端服务实现了坐标转换功能，确保在地图上显示的位置准确。

- **BD-09**: 百度地图坐标系统
- **GCJ-02**: 中国国测局坐标系统（火星坐标）
- **WGS-84**: 世界标准GPS坐标系统

## 中国地图服务说明

项目特别集成了针对中国地图的搜索服务：
- 百度地图搜索：支持中文地名搜索，提供丰富的国内POI数据
- 天地图搜索：国家测绘地理信息局提供的官方地图服务

## 数据存储

### 本地存储
- 所有数据默认保存在浏览器本地存储中
- 刷新页面后数据不会丢失
- 支持导出JSON文件进行长期保存

### 导出格式
- JSON格式：完整保存路书数据，便于导入和备份
- HTML格式：生成独立的HTML文件，可直接分享和查看

## 扩展功能

### 自定义图标
- 支持多种预设图标（数字、emoji、符号）
- 支持自定义文字和图标
- 可调整图标颜色

### 时间规划
- 为每个标记点设置具体时间
- 为连接线设置耗时和交通方式
- 按日期分组显示日程

## 开发计划

### 已完成
- 前端地图操作界面
- 标记点添加和编辑
- 连接线功能
- 多地图源支持
- 搜索功能
- 数据导入导出
- 本地存储
- 坐标转换（中国地图）

### 待开发
- 搜索优化
- 重构成Vue模式，提高扩展性
- 添加后台系统，支持保存加载列表
- 支持Docker部署
- 支持黑暗模式
- 更多地图服务集成

## 贡献指南

欢迎提交Issue和Pull Request来改进项目。

### 开发环境设置
1. 克隆项目
2. 在本地启动后端服务
3. 使用本地服务器或Nginx运行前端

## 许可证

本项目采用MIT许可证。详情请见 LICENSE 文件。

## 致谢

- [Leaflet](https://leafletjs.com/) - 交互式地图JavaScript库
- [OpenStreetMap](https://www.openstreetmap.org/) - 免费可编辑的世界地图
- 百度地图、高德地图、Google地图等地图服务提供方
- Nginx - 高性能HTTP和反向代理服务器

## 支持与反馈

如有问题或建议，请提交Issue或联系开发者。

## 常见问题

### 1. 为什么在地区搜索功能不准确？
由于地图服务的特殊性，本项目提供了专门的中国地图搜索服务（百度地图、天地图），可提供更准确的搜索结果。

### 2. 如何确保地图位置准确？
项目内置了坐标转换算法，将中国地图的特殊坐标系统转换为标准GPS坐标，确保位置显示准确。

### 3. 数据保存在哪里？
数据默认保存在浏览器的本地存储中，通过导出功能可保存到本地文件。

### 4. 是否可以在移动设备上使用？
是的，项目采用响应式设计，支持在移动设备上使用。

这个路书制作工具旨在为用户提供一个简单易用的地图路线规划工具，无论是规划旅行路线、记录行程轨迹，还是分享路线信息，都能满足您的需求。
